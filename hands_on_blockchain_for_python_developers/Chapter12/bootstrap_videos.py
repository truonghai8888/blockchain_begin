import json
import os

import ipfsapi
from populus.utils.wait import wait_for_transaction_receipt
from web3 import IPCProvider, Web3

w3 = Web3(IPCProvider("/tmp/geth.ipc"))

common_password = "bitcoin123"
accounts = []
with open("accounts.txt", "w") as f:
    for i in range(4):
        account = w3.personal.newAccount(common_password)
        accounts.append(account)
        f.write(account + "\n")

with open("address.txt", "r") as f:
    address = f.read().rstrip("\n")

with open("videos_sharing_smart_contract/build/contracts.json") as f:
    contract = json.load(f)
    abi = contract["VideosSharing"]["abi"]

VideosSharing = w3.eth.contract(address=address, abi=abi)

c = ipfsapi.connect()

coinbase = w3.eth.accounts[0]
coinbase_password = "this-is-not-a-secure-password"
# Transfering Ethers
for destination in accounts:
    nonce = w3.eth.getTransactionCount(Web3.toChecksumAddress(coinbase))
    txn = {
        "from": coinbase,
        "to": Web3.toChecksumAddress(destination),
        "value": w3.toWei("100", "ether"),
        "gas": 70000,
        "gasPrice": w3.toWei("1", "gwei"),
        "nonce": nonce,
    }
    txn_hash = w3.personal.sendTransaction(txn, coinbase_password)
    wait_for_transaction_receipt(w3, txn_hash)

# Transfering Coins
for destination in accounts:
    nonce = w3.eth.getTransactionCount(coinbase)
    txn = VideosSharing.functions.transfer(destination, 100).buildTransaction(
        {"from": coinbase, "gas": 70000, "gasPrice": w3.toWei("1", "gwei"), "nonce": nonce}
    )
    txn_hash = w3.personal.sendTransaction(txn, coinbase_password)
    wait_for_transaction_receipt(w3, txn_hash)

# Uploading Videos
directory = "stock_videos"
movies = os.listdir(directory)
length_of_movies = len(movies)
for index, movie in enumerate(movies):
    account = accounts[index // 7]
    ipfs_add = c.add(directory + "/" + movie)
    ipfs_path = ipfs_add["Hash"].encode("utf-8")
    title = movie.rstrip(".mp4")[:20].encode("utf-8")

    nonce = w3.eth.getTransactionCount(Web3.toChecksumAddress(account))
    txn = VideosSharing.functions.upload_video(ipfs_path, title).buildTransaction(
        {"from": account, "gas": 200000, "gasPrice": w3.toWei("30", "gwei"), "nonce": nonce}
    )
    txn_hash = w3.personal.sendTransaction(txn, common_password)
    wait_for_transaction_receipt(w3, txn_hash)
